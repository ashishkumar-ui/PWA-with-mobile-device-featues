var picture,fetchedLocation,shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationButton=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader");function initLocation(){"geolocation"in navigator||(locationButton.style.display="none")}function initMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((o,a)=>{t.call(navigator,e,o,a)}):Promise.reject(new Error("getUserMedia is not implemented"))}),navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(e=>{imagePickerArea.style.display="block"})}function openCreatePostModal(){createPostArea.style.transform="translateY(0vh)",captureButton.style.display="inline",initMedia(),initLocation(),defferedPrompt&&(defferedPrompt.prompt(),defferedPrompt.userChoice.then(e=>{console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added PWA App to Home Screen")}),defferedPrompt=null)}function closeCreatePostModal(){createPostArea.style.transform="translateY(100vh)",imagePickerArea.style.display="none",videoPlayer.style.display="none",canvasElement.style.display="none",locationButton.style.display="inline-block",locationLoader.style.display="none",titleInput.value="",locationInput.value="",videoPlayer&&videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop())}function createCards(e){var t=document.querySelector("#shared-moments"),o="";t.innerHTML="";for(let t=0;t<e.length;t++)o+=`<div class="shared-moment-card mdl-card mdl-shadow--2dp">      \n      <div class="mdl-card__body card-body">\n        <img src="${e[t].picture}" />        \n      </div>\n      <div class="mdl-card__supporting-text mdl-typography--text-center">${e[t].title} (${e[t].location})</div>\n    </div>`;t.innerHTML+=o}locationButton.addEventListener("click",e=>{locationButton.style.display="none",locationLoader.style.display="block",e.preventDefault(),navigator.geolocation.getCurrentPosition(e=>{fetchedLocation={lat:e.coords.latitude,lng:e.coords.longitude},console.log(e),fetch(`https://geocode.xyz/${fetchedLocation.lat},${fetchedLocation.lng}?json=1&auth=180947445731522388161x2832`).then(e=>e.json()).then(e=>{var t=e.city;e.osmtags&&e.osmtags.name&&(t+=", "+e.osmtags.name,locationInput.value=t,locationInput.parentElement.classList.add("is-focused"),locationLoader.style.display="none"),console.log(e)}).catch(e=>{console.log(e)})},e=>{console.log("Error getting location",e),locationButton.style.display="inline",locationLoader.style.display="none",fetchedLocation={lat:null,lng:null},alert("Could not fetch location, please enter manually!")},{timeout:15e3})}),captureButton.addEventListener("click",e=>{canvasElement.style.display="block",captureButton.style.display="none",videoPlayer.style.display="none";var t=canvasElement.getContext("2d"),o=canvasElement.width,a=videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width);t.drawImage(videoPlayer,0,0,o,a),videoPlayer&&videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop()),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",e=>{picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal);var postApiUrl="https://pwa-picnick.firebaseio.com/posts.json",networkDataReceived=!1;function sendData(e){let t=new FormData;t.append("id",e.id),t.append("title",e.title),t.append("location",e.location),t.append("file",e.picture,e.id+".png"),fetch("https://us-central1-pwa-picnick.cloudfunctions.net/storePostData",{method:"POST",body:t}).then(e=>{console.log("Send data",e)})}fetch(postApiUrl).then(e=>e.json()).then(e=>{console.log("From Network",e);var t=[];for(key in networkDataReceived=!0,e)t.push(e[key]);createCards(t)}),"indexedDB"in window&&readAllData("posts").then(e=>{networkDataReceived||(console.log("From indexDB",e),createCards(e))}),form.addEventListener("submit",e=>{if(e.preventDefault(),titleInput.value.trim().length&&locationInput.value.trim().length){var t={id:(new Date).toISOString(),title:titleInput.value.trim(),location:locationInput.value.trim(),picture:picture};closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(e=>{writeData("sync-posts",t).then(()=>{e.sync.register("sync-new-post")}).then(()=>{document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your post is saved for syncing!"})}).catch(e=>{console.log(e)})}):sendData(t)}else alert("Please enter valid data!")});